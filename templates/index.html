<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>{{ app_name }}</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#07070a;
  --card:#0f0f14;
  --text:#f5f5f7;
  --muted:#a1a1aa;
  --border:rgba(255,255,255,.10);
  --red:#ff2a2a;
  --green:#2ee59d;
  --radius:16px;
  --shadow:0 14px 35px rgba(0,0,0,.45);
}

*{box-sizing:border-box}

body{
  font-family:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:34px 18px;
  max-width:1060px;
  margin:0 auto;
}

.pill{
  display:inline-flex;
  gap:8px;
  align-items:center;
  padding:8px 12px;
  border-radius:999px;
  background:rgba(255,42,42,.1);
  border:1px solid rgba(255,42,42,.25);
  font-size:12px;
}

.panel{
  background:rgba(255,255,255,.03);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
}

button{
  padding:12px 16px;
  border-radius:12px;
  border:1px solid rgba(255,42,42,.4);
  background:linear-gradient(180deg,#ff2a2a,#b60000);
  color:#fff;
  font-weight:800;
  cursor:pointer;
}

#scannerOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.scannerBox{
  width:min(760px,100%);
  border-radius:18px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(20,20,25,.95);
  padding:18px;
}

.scanBar{
  height:10px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  overflow:hidden;
}

.scanBar > div{
  height:100%;
  width:5%;
  background:linear-gradient(90deg,rgba(255,42,42,.9),rgba(255,42,42,.35));
  transition:width 1200ms linear;
}

.scanSteps{
  display:grid;
  gap:10px;
  margin-top:14px;
}

.step{
  display:flex;
  gap:10px;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.25);
  font-size:13px;
}

.step .b{
  width:10px;
  height:10px;
  border-radius:999px;
  background:var(--red);
  box-shadow:0 0 0 6px rgba(255,42,42,.12);
  margin-top:4px;
  transition:background-color 1.2s ease, box-shadow 1.2s ease;
}

.step.done .b{
  background:var(--green);
  box-shadow:0 0 0 6px rgba(46,229,157,.12);
}

.small{
  color:var(--muted);
  font-size:12px;
  margin-top:10px;
}
</style>
</head>

<body>

<div id="scannerOverlay">
  <div class="scannerBox">
    <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
      <strong>üî¥ Scanning your territory‚Ä¶</strong>
      <span class="pill"><b>SignalZip</b></span>
    </div>

    <div class="scanBar"><div></div></div>

    <div class="scanSteps">
      <div class="step"><div class="b"></div><div>Locating businesses by zip + industry‚Ä¶</div></div>
      <div class="step"><div class="b"></div><div>Scoring payroll pain likelihood‚Ä¶</div></div>
      <div class="step"><div class="b"></div><div>Generating cold outreach copy‚Ä¶</div></div>
      <div class="step"><div class="b"></div><div>Mapping buying committee‚Ä¶</div></div>
    </div>

    <div class="small">Tip: The free scan shows the top 3. Pro unlocks the full list.</div>
  </div>
</div>

<header>
  <div>
    <h1>{{ app_name }}</h1>
    <div class="meta">Territory intelligence that feels curated ‚Äî not a giant list.</div>
  </div>

  <div class="pill">
    <span>Vertical:</span> <b>Payroll / HR</b>
  </div>
</header>

<div class="top-grid">
  <div class="panel">
    <h3>Live Territory Signals</h3>
    <div class="feed">
      <div class="feed-item">
        <div class="dot"></div>
        <div>
          <div class="t"><b>Fast Win:</b> Get 1 email + 1 LinkedIn note per account ‚Äî ready to copy.</div>
          <div class="s">No guessing. You leave with outreach text in seconds.</div>
        </div>
      </div>
      <div class="feed-item">
        <div class="dot"></div>
        <div>
          <div class="t"><b>Sniper Mode:</b> Top accounts are ranked first (avoid list fatigue).</div>
          <div class="s">You see priority, why, and the angle instantly.</div>
        </div>
      </div>
      <div class="feed-item">
        <div class="dot"></div>
        <div>
          <div class="t"><b>Decision Maker Jump:</b> Click into LinkedIn searches for the buying committee.</div>
          <div class="s">CEO/CFO/Ops/HR ‚Äî fast path to the right conversation.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h3>Scan My Territory</h3>
    <form method="post" action="/generate" id="scanForm">
      <input name="zip_codes" placeholder="Zip codes (comma separated) e.g., 75201, 75001" required />
      <input name="industry" placeholder="Industry (optional) e.g., construction" />
      <button type="submit">üî• Scan Territory</button>
    </form>

<div class="sub-actions">
  {% if is_premium %}
    <span class="pill"><b>Pro</b> active</span>

    <a class="link-btn" href="/export.csv">Export CSV</a>

    {% if email %}
    <form method="post" action="/billing-portal" style="display:inline;">
      <button type="submit" class="link-btn">Manage Billing</button>
    </form>
    {% endif %}

  {% else %}
    <span class="pill">Free scan: <b>Top 3</b></span>
  {% endif %}
</div>


    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}
  </div>
</div>

{% if results and results|length > 0 %}
  <div class="panel">
    <h3>Territory Opportunity Scoreboard</h3>
    <div class="scoreboard">
      <div class="big-score">
        <div class="k">Territory Opportunity Score</div>
        <div class="v">{{ scoreboard.territory_score }} / 10</div>
        <div class="hint">Average priority across scanned accounts ‚Äî higher means better ‚Äúpayroll pain likelihood‚Äù.</div>
      </div>
      <div class="breakdown">
        <div class="stat">
          <div class="n">{{ scoreboard.high }}</div>
          <div class="l">High Signal (8‚Äì10)</div>
        </div>
        <div class="stat">
          <div class="n">{{ scoreboard.mid }}</div>
          <div class="l">Mid Signal (5‚Äì7)</div>
        </div>
        <div class="stat">
          <div class="n">{{ scoreboard.low }}</div>
          <div class="l">Low Signal (1‚Äì4)</div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    {% for r in results %}
  <div class="card">

  <div class="card-head" style="cursor:pointer;" onclick="toggleCard('card-{{ loop.index }}')">
    <div>
      <h2>{{ loop.index }}. {{ r.name }} ‚Äî <span class="score">{{ r.priority_score }} / 10</span></h2>
      <div class="row-meta">
        <span>{{ r.zip }}</span>
        {% if r.industry %}<span>‚Ä¢ {{ r.industry }}</span>{% endif %}
      </div>
    </div>

    <div>
      {% if r.signal_type == 'Growth' %}
        {% if loop.first %}
          <span class="badge">üî• Highest Growth</span>
        {% endif %}
      {% else %}
        <span class="badge">üî• {{ r.signal_type }} Signal</span>
      {% endif %}
    </div>
  </div>
 <div id="card-{{ loop.index }}" style="display:none; margin-top:16px;">

    <div class="section">
      <div class="label">Why this account matters</div>
      <div style="color: rgba(255,255,255,.86);">{{ r.reason }}</div>
    </div>

    <div class="section">
      <div class="label">Likely Decision Makers</div>
      <ul>
        {% for e in r.executives %}
          <li>
            <a href="{{ e.linkedin_url }}" target="_blank">{{ e.name }}</a> ‚Äî {{ e.title }}
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="section">
      <div class="label">Likely Payroll Pain Points</div>
      <ul>
        {% for p in r.pain_points %}
          <li>{{ p }}</li>
        {% endfor %}
      </ul>
    </div>

    <div class="section">
      <div class="label">Suggested Cold Email</div>
      <div class="note">
        <pre>Hi {{ r.name }} Team,

{{ r.email_draft }}

Best,
[Your Name]</pre>
      </div>
    </div>

    <div class="section">
      <div class="label">LinkedIn Connection Note</div>
      <div class="note">
        <pre>{{ r.linkedin_note }}</pre>
      </div>
    </div>

  </div>

</div>
    {% endfor %}
  </div>
{% endif %}

{% if not is_premium and locked_count > 0 %}
 <div class="paywall" id="pro-upgrade">
    <h2>üîí {{ locked_count }} More High-Signal Accounts Hidden</h2>
    <p>Pro unlocks the full ranked list + CSV export. Don‚Äôt let your competitors grab these first.</p>

  <form method="post" action="/start-checkout" style="margin-top: 12px;">
  <input name="email" type="email" placeholder="Work email for Pro access" required
         style="max-width:420px; margin: 0 auto 10px; display:block;" />
  <button id="upgradeBtnTop" type="submit">Unlock SignalZip Pro</button>
  </form>


    <div class="locked-strip">
      <div class="lockpill">Unlimited scans</div>
      <div class="lockpill">Full ranked list</div>
      <div class="lockpill">CSV export</div>
      <div class="lockpill">Faster targeting</div>
    </div>

    <div class="small">
      (Today this is a demo premium toggle. Replace /upgrade with Stripe Checkout when ready.)
    </div>
  </div>
{% endif %}



<script>
  // Slower scanner UI (very slow fallback)
  const form = document.getElementById("scanForm");
  const overlay = document.getElementById("scannerOverlay");
  const scanBarInner = document.querySelector(".scanBar > div");
  const scanSteps = Array.from(document.querySelectorAll(".scanSteps .step"));

  function startScanAndSubmit(e) {
    e.preventDefault();
    if (!form) return;

    overlay.style.display = "flex";
    scanSteps.forEach(s => s.classList.remove("done"));
    if (scanBarInner) {
      scanBarInner.style.transition = "none";
      scanBarInner.style.width = "2%";
    }

    const thresholds = [0.12, 0.40, 0.72, 0.92];
    const slowDuration = 6000000; // 100 minutes (10x slower than previous 10-minute fallback)
    let lastUploadPct = 0;
    let progress = 0;
    let intervalId = null;
    const stepTimeouts = [];

    function setProgress(pct) {
      progress = Math.min(1, Math.max(progress, pct));
      const width = 2 + 98 * progress; // start near 2%
      if (scanBarInner) {
        scanBarInner.style.transition = "width 72000ms linear";
        scanBarInner.style.width = width + "%";
      }
      for (let i = 0; i < scanSteps.length; i++) {
        if (progress >= (thresholds[i] || 1)) {
          scanSteps[i].classList.add("done");
        }
      }
    }

    // schedule extremely slow timed completions for each step
    for (let i = 0; i < thresholds.length; i++) {
      const t = thresholds[i];
      const ms = Math.round(slowDuration * t);
      stepTimeouts.push(setTimeout(() => {
        scanSteps[i].classList.add("done");
        setProgress(Math.max(progress, t + 0.005));
      }, ms));
    }

    const startTime = Date.now();
    intervalId = setInterval(() => {
      const elapsed = Date.now() - startTime;
      const est = Math.min(0.99, elapsed / slowDuration);
      const visible = Math.max(est, lastUploadPct, progress);
      setProgress(visible);
      if (visible >= 0.99) {
        clearInterval(intervalId);
        intervalId = null;
      }
    }, 1000); // update once per second (sufficient for extremely slow animation)

    const xhr = new XMLHttpRequest();
    xhr.open("POST", form.action);
    xhr.withCredentials = true;
    const fd = new FormData(form);

    xhr.upload.onprogress = (ev) => {
      if (ev.lengthComputable) {
        lastUploadPct = ev.loaded / ev.total;
        setProgress(lastUploadPct);
      }
    };

    xhr.onreadystatechange = () => {
      if (xhr.readyState === 4) {
        if (intervalId) { clearInterval(intervalId); intervalId = null; }
        stepTimeouts.forEach(id => clearTimeout(id));
        setProgress(1);
        scanSteps.forEach(s => s.classList.add("done"));
        setTimeout(() => {
          try {
            document.open();
            document.write(xhr.responseText);
            document.close();
          } catch (err) {
            if (xhr.responseURL) window.location.href = xhr.responseURL;
            else overlay.style.display = "none";
          }
        }, 600);
      }
    };

    xhr.onerror = () => {
      if (intervalId) { clearInterval(intervalId); intervalId = null; }
      stepTimeouts.forEach(id => clearTimeout(id));
      setProgress(1);
      scanSteps.forEach(s => s.classList.add("done"));
      setTimeout(() => {
        overlay.style.display = "none";
        alert("Upload failed. Please try again.");
      }, 700);
    };

    xhr.send(fd);
  }

  if (form) form.addEventListener("submit", startScanAndSubmit);

  // helpers
  function toggleCard(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const hidden = el.style.display === "none" || getComputedStyle(el).display === "none";
    el.style.display = hidden ? "block" : "none";
    if (hidden) el.scrollIntoView({ behavior: "smooth", block: "center" });
  }

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-copy]");
    if (!btn) return;
    const id = btn.getAttribute("data-copy");
    const el = document.getElementById(id);
    if (!el) return;
    try {
      await navigator.clipboard.writeText(el.innerText);
      const old = btn.innerText;
      btn.innerText = "Copied ‚úì";
      setTimeout(() => btn.innerText = old, 900);
    } catch {
      const range = document.createRange();
      range.selectNodeContents(el);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      const old = btn.innerText;
      btn.innerText = "Select + Cmd+C";
      setTimeout(() => btn.innerText = old, 1200);
    }
  });
</script>

</body>
</html>
